{% if header %}
<!DOCTYPE html>
<html>
{% block header %}
{% endblock %}
<link rel="manifest" href="/manifest.json">
<body>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="/static/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="/static/css/bootstrap-theme.min.css">

<!-- Include stylesheet -->
<link href="/static/simplemde.min.css" rel="stylesheet">
<!-- Include the Quill library -->
<script src="/static/simplemde.min.js"></script>

<script>

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js').then(
  function(registration) {
    console.log("success!");
    if (registration.installing) {
      registration.installing.postMessage("Howdy from your installing page.");
    }
  },
  function(why) {
    console.error("Installing the worker failed!:", why);
  });
}

function myFunction(evt) {
    var container = evt.target;
    var index;
    while(container)
    {
      var container_args = container.className.split(' ');
      if(container_args[0] == 'panel')
      {
        break;
      }
      container = container.parentNode; 
    }
    for (index=0; index < container.children.length; index=index+1)
    {
      if(container.children[index].className.split(' ')[0] =='panel-body')
      {
        container = container.children[index];
        break;
      }
    }
    //var container = evt.path[3].children[1];
    if(container.style.maxHeight==="")
    {
      container.style.maxHeight="300px";
      evt.target.textContent="+";
    }
    else
    {
      container.style.maxHeight="";
      evt.target.textContent="-";
    }
}

function showOfflineAlert(err)
{
    var content = document.getElementById("alerts-content");  
    content.innerHTML='<div class="alert alert-danger" role="alert">'+err+'</div>';
    return "";
}

function loadContentLink(evt)
{
var url = evt.currentTarget.href;
fetch(url+'&no_header',
{
  credentials: 'include'
  }).then(function(responseObj)
  {
    document.getElementById("alerts-content").innerHTML='';
    return responseObj.text();
  },showOfflineAlert
  ).then(function(text) 
  {
    var content = document.getElementById("content");
    content.innerHTML=text;
  });
  return false;
}

function loadMoreLink(evt)
{
var url = document.getElementById("nextUrl").href;
fetch(url+'&no_header',
{
  credentials: 'include'
}).then(function(responseObj) 
{
  //console.log('status: ', responseObj.status);
  return responseObj.text();
},showOfflineAlert).then(function(text) 
{
  //console.log('html: ', text);
  var overflow = document.getElementById("overflow");
  var feed = document.getElementById("content");
  overflow.parentNode.removeChild(overflow);
  var next_div = document.createElement("div");
  next_div.innerHTML=text;
  feed.appendChild(next_div);
});
return false;
}

function likeLink(evt)
{
    var form=evt.currentTarget.parentNode;
fetch('{{ base_url }}action', {
	method: 'post',
    credentials: 'include',
	body: new FormData(form)
 }).then(function(responseObj) 
{
  if (responseObj.status !== 200) 
  {
    console.log('status: ', responseObj.status);
    responseObj.text().then(function(text)
    {
      console.log('html: ', text);
    });
  }
  else responseObj.json().then(function(json) 
  {
    //console.log('html: ', json);
    var element = form.getElementsByTagName("span");
    //console.log(form[0]);
    var liked = json["liked"];
    if (liked == "1")
    {
      element[0].style.color="orange";
      form[0].value="0";
    }
    else
    {
      element[0].style.color="";
      form[0].value="1";
    }
  });  
},showOfflineAlert);
return false;
}

var editor = (
    function() {
    var editor_url = '{{ base_url }}action';
    var update = false;
    function sendPost(evt)
    {
        var form=evt.currentTarget.parentNode.parentNode.parentNode;
        
        var form_data = new FormData(form);
        
        if (update)
        {
            form_data.set('action','update');
        }
        
        form_data.set('description',simplemde.value());
        fetch(editor_url, {
        method: 'post',
        credentials: 'include',
        body: form_data,
     }).then(function(responseObj) 
    {
        responseObj.json().then(function(text)
        {
          console.log('html: ', text);
          var next_div = document.createElement("div");
          var content = document.getElementById("content");
          next_div.innerHTML=text['html'];
          content.insertBefore(next_div, content.firstChild);
          simplemde.value("");
        });
    },showOfflineAlert);
    return false;
    }

    function editPost(evt)
    {
        var form=evt.currentTarget.parentNode;
        
        var form_data = new FormData(form);
        fetch(form.action.formAction+'?json', {
        method: 'post',
        credentials: 'include',
        body: form_data,
     }).then(function(responseObj) 
    {
        responseObj.json().then(function(text)
        {
          console.log('html: ', text);
          document.getElementById('editor-submit-button').text = ' Update';
          document.getElementById('editor-panel').style.display = 'block';
          simplemde.value(text.post.description);

          update = true;
          editor_url = form.action.formAction;
          // show editor
          //form.style.display = 'none';

        });
    },showOfflineAlert);
    return false;
    }
    
    return {
    editPost: function(evt) {
      editPost(evt);
    },
    sendPost: function(evt) {
     sendPost(evt);
    }

    };
    })();
    
function sendPost(evt)
{
   editor.sendPost(evt);
}
</script>

<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="navbar-brand">RSS</div>
    </div>
    <nav id="bs-navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
{% if login %}
        <li class="dropdown">
        <a href="#" class="active" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Feed <span class="caret"></span></a>
        <ul class="dropdown-menu">
            <li><a href="{{ base_url }}?" onclick="return loadContentLink(event)">Alll</a></li>
            <li><a href="{{ base_url }}?liked" onclick="return loadContentLink(event)">Pinned</a></li>
            <li><a href="{{ base_url }}feed/{{ request.user.username }}?" onclick="return loadContentLink(event)">Local</a></li>
            <li><a href="{{ base_url }}feeds?" onclick="return loadContentLink(event)">Feeds</a></li>
        </ul>
        </li>
{% else %} 
         <li class="active" id="navbar_home"><a>Feed</a></li>
{% endif %}
      </ul>
      
      <div id="login_form">
      {% if login %}
            <form class="navbar-form navbar-right" method="post" action="{{ base_url }}">
	    {% csrf_token %}
            <input type="hidden" name="action" value="logout">
            <button id="logout-submit" type="submit" class="btn btn-success">Sign Out</button>
            </form>           
      {% else %}            
          <form class="navbar-form navbar-right" id="login-form" action="" method="post">
	        {% csrf_token %}
                <input type="hidden" name="action" value="login">
                <div class="form-group">
                  <input id="login-username" name="username" type="text" placeholder="Username" class="form-control">
                </div>
                <div class="form-group">
                  <input id="login-password" name="password" type="password" placeholder="Password" class="form-control">
                </div>
                <button id="login-submit" type="submit" class="btn btn-success">Sign in</button>
           </form>            
      {% endif %}
       </div>
    </nav><!--/.navbar-collapse -->
  </div>
</nav>
<div id="alerts-content" style="margin-top:62px">
</div>
<!-- Editor we keep this around as loading it is quite slow! -->
{% if login %}
<form action="" method="post" id="editor-panel" style="display:none">
<input type="hidden" name="action" value="post">
<input type="hidden" name="content_type" value="text/x-markdown">
{% csrf_token %}
<div class="panel panel-default" style="margin-left:50px;margin-right:50px;margin-top:5px;">
<div class="panel-heading">
	 <h3 class="panel-title"> 
	 <button type="button" onclick="myFunction(event)">+</button>
	 <a href="{{ item.feed.url }}">{{ item.feed.title|safe }}</a>:
         Title <input type="text" name="title"></h3>
	 </div>
<div class="panel-body">
  <textarea name="description" id="editor"></textarea>
</div>
<div class="panel-footer">
<button type="button" class="btn btn-primary btn-sm" id="editor-submit-button" onclick="return sendPost(event);">
  <span class="glyphicon glyphicon-save" aria-hidden="true"></span> Post 
</button>
</div>
</div>
</form>
{% endif %}
<div id="content">
{% endif %}
{% block content %}
<div class="alert alert-warning" role="alert">Warning offline, using
cached pages rather then live pages.</div>
{% endblock %}

{% if header %}
</div>
<script>
console.log("init editor");
var simplemde = new SimpleMDE({ element: document.getElementById("editor") });
</script>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="/static/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="/static/js/bootstrap.min.js"></script>
</body>
</html>
{% endif %}
